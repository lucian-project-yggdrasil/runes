{"version":3,"sources":["../../src/social/logic.ts","../../src/core/constants.ts","../../src/core/cosmos/client.ts","../../src/core/logger/index.ts","../../src/core/cosmos/repository.ts","../../src/social/repository.ts","../../src/social/schemas.ts"],"sourcesContent":["import { DateTime } from \"luxon\"\nimport type { Frequency, Friend, RelationshipStatus } from \"./schemas\"\n\nconst FREQUENCY_DAYS: Record<Frequency, number> = {\n\tweekly: 7,\n\tmonthly: 30,\n\tquarterly: 90,\n\tyearly: 365,\n\t\"ad-hoc\": 9999,\n}\n\n/**\n * Calculates the health of a relationship based on frequency targets.\n */\nexport const getRelationshipStatus = (friend: Friend): RelationshipStatus => {\n\t// Unknown / New\n\tif (!friend.lastContactedAt) return \"unknown\"\n\n\t// Ad-hoc (Never decays)\n\tif (friend.targetFrequency === \"ad-hoc\") return \"healthy\"\n\n\tconst lastContact = DateTime.fromISO(friend.lastContactedAt)\n\tconst now = DateTime.now()\n\tconst daysSince = Math.floor(now.diff(lastContact, \"days\").days)\n\tconst target = FREQUENCY_DAYS[friend.targetFrequency]\n\n\tif (daysSince <= target) return \"healthy\"\n\tif (daysSince <= target * 1.5) return \"decaying\" // Grace Period\n\treturn \"critical\"\n}\n","export const YGGDRASIL_DB = \"yggdrasil-data\"\n\nexport const CONTAINERS = {\n\tUSERS: \"users\",\n\tFRIENDS: \"friends\",\n} as const\n","import { CosmosClient } from \"@azure/cosmos\"\nimport { Logger } from \"../logger\"\n\nlet clientInstance: CosmosClient | null = null\n\nexport const getCosmosClient = () => {\n\t// If we already have a connection, reuse it!\n\tif (clientInstance) {\n\t\treturn clientInstance\n\t}\n\n\t// Otherwise, look for the key\n\tconst connectionString = process.env.COSMOS_CONNECTION_STRING\n\n\tif (!connectionString) {\n\t\t// Critical failure. The app cannot function without memory.\n\t\tLogger.error(\"CRITICAL: COSMOS_CONNECTION_STRING is missing from environment variables.\")\n\t\tthrow new Error(\"COSMOS_CONNECTION_STRING is missing.\")\n\t}\n\n\tLogger.info(\"âš¡ Initializing new Cosmos Client Connection...\")\n\n\t// Create the connection\n\tclientInstance = new CosmosClient(connectionString)\n\treturn clientInstance\n}\n","export type LogLevel = \"info\" | \"warn\" | \"error\" | \"debug\"\n\nclass RunesLogger {\n\tprivate isDev = process.env.NODE_ENV !== \"production\"\n\n\tprivate format(level: LogLevel, message: string, data?: unknown) {\n\t\tconst timestamp = new Date().toISOString()\n\n\t\tif (this.isDev) {\n\t\t\t// Colors: Error=Red, Info=Cyan, Warn=Yellow\n\t\t\tconst color = level === \"error\" ? \"\\x1b[31m\" : level === \"warn\" ? \"\\x1b[33m\" : \"\\x1b[36m\"\n\t\t\tconst reset = \"\\x1b[0m\"\n\n\t\t\tconsole.log(`${color}[${level.toUpperCase()}]${reset} ${message}`)\n\t\t\tif (data) console.dir(data, { depth: null, colors: true })\n\t\t} else {\n\t\t\t// For Azure Monitor / Log Analytics\n\t\t\tconsole.log(\n\t\t\t\tJSON.stringify({\n\t\t\t\t\ttimestamp,\n\t\t\t\t\tlevel,\n\t\t\t\t\tmessage,\n\t\t\t\t\tdata,\n\t\t\t\t\tapp: process.env.WEBSITE_SITE_NAME || \"Local\",\n\t\t\t\t}),\n\t\t\t)\n\t\t}\n\t}\n\n\tinfo(message: string, data?: unknown) {\n\t\tthis.format(\"info\", message, data)\n\t}\n\terror(message: string, data?: unknown) {\n\t\tthis.format(\"error\", message, data)\n\t}\n\twarn(message: string, data?: unknown) {\n\t\tthis.format(\"warn\", message, data)\n\t}\n\tdebug(message: string, data?: unknown) {\n\t\tthis.format(\"debug\", message, data)\n\t}\n}\n\nexport const Logger = new RunesLogger()\n","import type { Container, JSONValue, SqlQuerySpec } from \"@azure/cosmos\"\nimport { YGGDRASIL_DB } from \"../constants\"\nimport { Logger } from \"../logger\"\nimport { getCosmosClient } from \"./client\"\n\ninterface CosmosError {\n\tcode?: number\n\tmessage?: string\n\tbody?: unknown\n}\n\nexport interface BaseEntity {\n\tid: string // UUID\n\ttenantId: string // Partition Key\n}\n\nexport abstract class CosmosRepository<T extends BaseEntity> {\n\tprivate container: Container | null = null\n\n\tconstructor(private containerName: string) {}\n\n\t/**\n\t * Lazy-loads the container.\n\t * Ensures we reuse the Single Connection from 'client.ts'.\n\t */\n\tprotected async getContainer(): Promise<Container> {\n\t\tif (!this.container) {\n\t\t\tconst client = getCosmosClient()\n\t\t\tconst database = client.database(YGGDRASIL_DB)\n\n\t\t\t// Auto-provision container if missing\n\t\t\tconst { container } = await database.containers.createIfNotExists({\n\t\t\t\tid: this.containerName,\n\t\t\t\tpartitionKey: \"/tenantId\",\n\t\t\t})\n\n\t\t\tthis.container = container\n\t\t}\n\t\treturn this.container\n\t}\n\n\tasync create(item: T): Promise<T> {\n\t\tconst container = await this.getContainer()\n\t\tLogger.info(`[Cosmos] Creating item in ${this.containerName}`, { id: item.id })\n\n\t\tconst { resource } = await container.items.create(item)\n\t\treturn resource as T\n\t}\n\n\tasync get(id: string, tenantId: string): Promise<T | null> {\n\t\tconst container = await this.getContainer()\n\n\t\ttry {\n\t\t\tconst { resource } = await container.item(id, tenantId).read()\n\t\t\treturn (resource as T) || null\n\t\t} catch (error: unknown) {\n\t\t\t// Non-existing item\n\t\t\tconst cosmosError = error as CosmosError\n\t\t\tif (cosmosError.code === 404) return null\n\t\t\tthrow error\n\t\t}\n\t}\n\n\tasync fetchAll(tenantId: string): Promise<T[]> {\n\t\tconst container = await this.getContainer()\n\n\t\tconst querySpec: SqlQuerySpec = {\n\t\t\tquery: \"SELECT * FROM c WHERE c.tenantId = @tenantId\",\n\t\t\tparameters: [{ name: \"@tenantId\", value: tenantId }],\n\t\t}\n\n\t\tconst { resources } = await container.items.query(querySpec).fetchAll()\n\t\treturn resources as T[]\n\t}\n\n\tasync update(item: T): Promise<T> {\n\t\tconst container = await this.getContainer()\n\t\tconst { resource } = await container.items.upsert<T>(item)\n\t\treturn resource as T\n\t}\n\n\tasync delete(id: string, tenantId: string): Promise<void> {\n\t\tconst container = await this.getContainer()\n\t\tawait container.item(id, tenantId).delete()\n\t}\n\n\t/**\n\t * Custom Query\n\t * Allows specific WHERE clauses, but forces Tenant ID injection.\n\t */\n\tasync query(\n\t\ttenantId: string,\n\t\tquery: string,\n\t\tparameters: { name: string; value: JSONValue }[] = [],\n\t): Promise<T[]> {\n\t\tconst container = await this.getContainer()\n\t\tconst safeQuery = `${query} AND c.tenantId = @tenantId`\n\n\t\tconst querySpec: SqlQuerySpec = {\n\t\t\tquery: safeQuery,\n\t\t\tparameters: [...parameters, { name: \"@tenantId\", value: tenantId }],\n\t\t}\n\n\t\tconst { resources } = await container.items.query(querySpec).fetchAll()\n\t\treturn resources as T[]\n\t}\n}\n","import { CosmosRepository } from \"../core\"\nimport { CONTAINERS } from \"../core/constants\"\nimport type { Friend, Interaction } from \"./schemas\"\n\nexport class FriendRepository extends CosmosRepository<Friend> {\n\tconstructor() {\n\t\tsuper(CONTAINERS.FRIENDS)\n\t}\n\n\tasync findByEmail(tenantId: string, email: string): Promise<Friend | null> {\n\t\tconst results = await this.query(tenantId, \"SELECT * FROM c WHERE c.email = @email\", [\n\t\t\t{ name: \"@email\", value: email },\n\t\t])\n\t\treturn results[0] || null\n\t}\n\n\tasync logInteraction(\n\t\tfriendId: string,\n\t\ttenantId: string,\n\t\tinteraction: Interaction,\n\t): Promise<void> {\n\t\tconst container = await this.getContainer()\n\n\t\tawait container.item(friendId, tenantId).patch([\n\t\t\t// Note: \"/interactions/-\" appends, \"/0\" prepends (Reverse Chronological is better for UI)\n\t\t\t{ op: \"add\", path: \"/interactions/0\", value: interaction },\n\t\t\t{ op: \"add\", path: \"/lastContactedAt\", value: interaction.date },\n\t\t])\n\t}\n}\n","import { z } from \"zod\"\n\n// ========================================\n// ENUMS & HELPERS\n// ========================================\n\nexport const TierSchema = z.enum([\"inner\", \"outer\", \"network\"])\nexport const FrequencySchema = z.enum([\n\t\"weekly\", // 7 days (Inner Circle)\n\t\"monthly\", // 30 days (Close Friends)\n\t\"quarterly\", // 90 days (Network)\n\t\"yearly\", // 365 days (Distant)\n\t\"ad-hoc\", // No pressure (Coworkers)\n])\nexport const InteractionTypeSchema = z.enum([\"call\", \"text\", \"meet\", \"social\", \"email\"])\nexport const InteractionSchema = z.strictObject({\n\tid: z.uuid(),\n\tdate: z.iso.datetime(), // ISO 8601\n\ttype: InteractionTypeSchema,\n\tnotes: z.string().optional(),\n})\nexport const RelationshipStatusSchema = z.enum([\"healthy\", \"decaying\", \"critical\", \"unknown\"])\n\n// ========================================\n// FRIEND MODEL\n// ========================================\n\nexport const FriendSchema = z.strictObject({\n\t// Infrastructure\n\tid: z.uuid(), // UUID\n\ttenantId: z.string().min(1, \"Tenant ID is required\"), // Partition Key\n\tcreatedAt: z.iso.datetime(),\n\tupdatedAt: z.iso.datetime().optional(),\n\n\t// Identity\n\tname: z.string().min(1, \"Name is required\"),\n\temail: z.email().optional(),\n\tavatarUrl: z.url().optional(),\n\n\t// The Engine (Decay Algorithm)\n\ttier: TierSchema.default(\"network\"),\n\ttargetFrequency: FrequencySchema.default(\"monthly\"),\n\tlastContactedAt: z.iso.datetime().optional(),\n\n\t// Context\n\tbirthday: z\n\t\t.string()\n\t\t.regex(/^\\d{2}-\\d{2}$/, \"Format MM-DD\")\n\t\t.optional(),\n\ttags: z.array(z.string()).default([]),\n\tfacts: z.array(z.string()).default([]),\n\tinteractions: z.array(InteractionSchema).default([]),\n})\n\n// ========================================\n// DTO\n// ========================================\n\nexport const CreateFriendSchema = FriendSchema.omit({\n\t// Blacklisted props\n\tid: true,\n\ttenantId: true,\n\tcreatedAt: true,\n\tupdatedAt: true,\n\tinteractions: true,\n})\nexport const UpdateFriendSchema = CreateFriendSchema.partial()\n\n// ========================================\n// INFERRED TYPES\n// ========================================\n\nexport type Tier = z.infer<typeof TierSchema>\nexport type Frequency = z.infer<typeof FrequencySchema>\nexport type InteractionType = z.infer<typeof InteractionTypeSchema>\nexport type Interaction = z.infer<typeof InteractionSchema>\nexport type RelationshipStatus = z.infer<typeof RelationshipStatusSchema>\n\nexport type Friend = z.infer<typeof FriendSchema>\nexport type CreateFriendDto = z.infer<typeof CreateFriendSchema>\nexport type UpdateFriendDto = z.infer<typeof UpdateFriendSchema>\n"],"mappings":"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","names":[]}